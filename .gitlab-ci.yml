image: python:3

stages:
  - build
  - test
  - deploy

'Build':
  stage: build
  script:
    - pip install -r requirements_dev.txt --upgrade
    - pip install -r requirements.txt --upgrade
    - rm -rf build dist *.egg-info .eggs
    - python setup.py bdist_wheel
  artifacts:
    paths:
      - dist/

'Changelog':
  stage: build
  image: local
  script:
    - set +x
    - mkdir -p ./.tmp/
    - ls ./.tmp/git-chglog >/dev/null 2>&1 || wget -O ./.tmp/git-chglog -q https://github.com/git-chglog/git-chglog/releases/download/0.9.1/git-chglog_linux_amd64
    - chmod +x ./.tmp/git-chglog
    - echo ''
    - 'read -p " > Release tag : " -r tag'
    - git tag -f -m '' "${tag}"
    - ./.tmp/git-chglog -o CHANGELOG.md
    - git add -v CHANGELOG.md
    - 'git commit -m "CHANGELOG: regenerate release tag changes history"'
    - git tag -f -m '' "${tag}"
    - ./.tmp/git-chglog -o CHANGELOG.md
    - git add -v CHANGELOG.md
    - git commit --amend --no-edit
    - git tag -f -m '' "${tag}"
  tags:
    - local
  only:
    - local

'Development':
  stage: build
  image: local
  script:
    - sudo rm -rf build dist *.egg-info .eggs
    - python3 setup.py bdist_wheel
    - pip3 install --upgrade --no-deps dist/*.whl
  tags:
    - local
  only:
    - local

'Unit Tests':
  stage: test
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    # DOCKER_HOST: tcp://docker:2375
    FORCE_STYLING: 'true'
    TEMP: .tmp
    TERM: ansi
  script:
    - mkdir -p ./.tmp/
    - pip install dist/*.whl
    - pip install --no-deps --upgrade dist/*.whl
    - pip show gitlabci-local
    - gitlabci-local -h
    - gitlabci-local -c unknown/.gitlab-ci.yml && exit 1 || true
    - gitlabci-local -c ./examples/.gitlab-ci.yml -d
    - gitlabci-local -c ./tests/simple/.gitlab-ci.yml </dev/null && exit 1 || true
    - gitlabci-local -c ./tests/simple/.gitlab-ci.yml -p
    - gitlabci-local -c ./tests/simple/.gitlab-ci.yml -q -p
    - gitlabci-local -c ./tests/unsorted/.gitlab-ci.yml -p
    - gitlabci-local -b -a -c ./tests/templates/.gitlab-ci.yml 'Job 1' 'Job 2' 'Job 3'
    - gitlabci-local -b -a -c ./tests/failures/.gitlab-ci.yml -p && exit 1 || true
    - gitlabci-local -c ./tests/failures/.gitlab-ci.yml 'Job 1' 'Job 2'
    - gitlabci-local -c ./tests/stages/.gitlab-ci.yml unknown_job && exit 1 || true
    - gitlabci-local -c ./tests/stages/.gitlab-ci.yml -p unknown_stage && exit 1 || true
    - gitlabci-local -c ./tests/stages/.gitlab-ci.yml -p && exit 1 || true
    - gitlabci-local -c ./tests/stages/.gitlab-ci.yml -p one two
    - gitlabci-local -c ./tests/stages/.gitlab-ci.yml -s -p one two </dev/null
    - gitlabci-local -c ./tests/tags/.gitlab-ci.yml -p
    - gitlabci-local -c ./tests/tags/.gitlab-ci.yml -m -p && exit 1 || true
    - gitlabci-local -c ./tests/tags/.gitlab-ci.yml -t 'upload' -p && exit 1 || true
    - gitlabci-local -c ./tests/tags/.gitlab-ci.yml 'Job 3'
    - gitlabci-local -c ./tests/tags/.gitlab-ci.yml -p three && exit 1 || true
    - gitlabci-local -c ./tests/tags/.gitlab-ci.yml -m -p three
    - gitlabci-local -c ./tests/configurations/.gitlab-ci.yml -p && exit 1 || true
    - gitlabci-local -c ./tests/configurations/.gitlab-ci.yml -p </dev/null && exit 1 || true
    - VARIABLE_8=value8 gitlabci-local -c ./tests/configurations/.gitlab-ci.yml -p </dev/null && exit 1 || true
    - VARIABLE_8= VARIABLE_11=value11 gitlabci-local -c ./tests/configurations/.gitlab-ci.yml -p </dev/null
    - gitlabci-local -c ./tests/configurations/.gitlab-ci.yml -e VARIABLE_8=value8 -e VARIABLE_11=value11 -p </dev/null
    - gitlabci-local -c ./tests/environment/.gitlab-ci.yml -p
    - gitlabci-local -c ./tests/environment/.gitlab-ci.yml -e USER -e VALUE_1=set1 -e VALUE_2=set2 -e VALUE_3=set3 -p
    - gitlabci-local -c ./tests/environment/.gitlab-ci.yml -e FOLDER=${PWD} -v ./ 'Job 2'
    - gitlabci-local -c ./tests/environment/.gitlab-ci.yml -v ./:/opt 'Job 2'
    - gitlabci-local -c ./tests/environment/.gitlab-ci.yml -v ./:/opt -w /opt/ 'Job 2'
    - gitlabci-local -c ./tests/entrypoints/.gitlab-ci.yml -d
    - gitlabci-local -c ./tests/entrypoints/.gitlab-ci.yml -p

'Deploy Test':
  stage: deploy
  variables:
    TWINE_PASSWORD_TEST: ${TWINE_PASSWORD_TEST}
  script:
    - pip install -r requirements_dev.txt --upgrade
    - python setup.py bdist_wheel
    - twine upload -u '__token__' -p "${TWINE_PASSWORD_TEST}" --repository testpypi dist/*
  only:
    - tags
  when: manual

'Deploy Release':
  stage: deploy
  variables:
    TWINE_PASSWORD: ${TWINE_PASSWORD}
  script:
    - pip install -r requirements_dev.txt --upgrade
    - python setup.py bdist_wheel
    - twine upload -u '__token__' -p "${TWINE_PASSWORD}" dist/*
  only:
    - tags
  when: manual
